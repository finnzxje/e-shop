# Product View Tracking

This document describes how the `product_views` and `product_interaction_events` tables work and what the frontend needs to send so that product interactions are captured consistently for analytics and future recommendations.

## What Gets Stored

| Column       | Source                                          | Notes                                                                                                                     |
| ------------ | ----------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------- |
| `user_id`    | Backend resolves from the authenticated request | `NULL` when the visitor is anonymous.                                                                                     |
| `session_id` | Provided by the frontend                        | Required when the visitor is anonymous; still useful for logged-in users to separate browsing sessions.                   |
| `product_id` | Path parameter                                  | Must exist; validation fails otherwise.                                                                                   |
| `variant_id` | Optional body field                             | Helps capture color/size interest. If supplied it must belong to the same product.                                        |
| `metadata`   | Optional JSON body field                        | Flexible context bag (page name, experiment bucket, etc.). Defaults to `{}`.                                              |
| `viewed_at`  | Populated automatically                         | Timestamp of the insert. A trigger also copies the record into `product_interaction_events` with interaction type `VIEW`. |

## API Endpoint

```
POST /api/catalog/products/{productId}/views
Content-Type: application/json
```

### Request Body

```json
{
  "sessionId": "550e8400-e29b-41d4-a716-446655440000",
  "variantId": "5c89e757-1f64-4a54-8e8f-4219c9753ae8",
  "metadata": {
    "page": "product-detail",
    "placement": "hero",
    "experiment": "rec-model-a"
  }
}
```

- `sessionId` – UUID generated by the frontend (see below). Required for anonymous visitors; strongly recommended for logged-in users.
- `variantId` – Optional UUID if the view corresponds to a specific variant (size/color). Skip it for generic product cards.
- `metadata` – Optional JSON object. Omit it or send `{}` when you don’t have any extra details.

### Responses

- `201 Created` – The view was recorded successfully. The body is empty.
- `400 Bad Request` – Neither `sessionId` nor an authenticated user was supplied.
- `404 Not Found` – The product (or variant) referenced does not exist.

## Frontend Session Handling

1. **Check for an existing session token** whenever the SPA boots (cookie or localStorage).
2. **Create a new UUID** (e.g. `crypto.randomUUID()`) if none exists. Persist it so subsequent requests reuse the same value.
3. **Attach the session UUID** to every call to `POST /views`.
4. **Keep using the same session id after login.** The backend stores the new `user_id` alongside the session so historical anonymous views can be linked later.
5. **Start a new session** if the visitor explicitly signs out or you want to segment a brand-new browsing journey.

## Recommended Call Flow

- Product listing page renders → fire a `POST /views` call for each impression you care about (or just the detail view when opened), including the session id.
- Logged-in user: include the access token so the backend can store both `user_id` and `session_id`.
- Anonymous user: omit the auth header; the call is allowed because `/api/catalog/**` is permitted for unauthenticated traffic. Make sure `sessionId` is present.

## Why We Keep `metadata`

The flexible JSON column avoids future schema changes. Some lightweight ideas:

- `{"page":"search","query":"blue shoes"}`
- `{"component":"related-items","position":2}`
- `{"device":"mobile"}`

Feel free to leave it blank; the backend automatically stores `{}`.

## Linking Anonymous Views After Login

Once the frontend has stored the access token, call the dedicated endpoint to claim earlier anonymous views:

```
POST /api/catalog/products/views/link-session
Authorization: Bearer <access token>
Content-Type: application/json

{
  "sessionId": "550e8400-e29b-41d4-a716-446655440000"
}
```

The backend updates both `product_views` and `product_interaction_events` rows where `session_id` matches and `user_id` is still `NULL`. The call is idempotent, so feel free to retry if the network fails.

If you ever need to perform the linkage manually (for example, during a bulk backfill), you can reuse the SQL directly:

```sql
UPDATE product_views
   SET user_id = :userId
 WHERE session_id = :sessionId
   AND user_id IS NULL;

UPDATE product_interaction_events
   SET user_id = :userId
 WHERE session_id = :sessionId
   AND user_id IS NULL;
```
